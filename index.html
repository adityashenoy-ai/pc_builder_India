<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Indian PC Builder Wizard</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for a clean, tech aesthetic */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117; /* Dark background */
        }
        .card {
            background-color: #161b22; /* Slightly lighter dark card */
            border-color: #30363d;
        }
        .step-indicator.active {
            background-color: #2563eb; /* Blue primary color */
            border-color: #1e40af;
        }
        .step-indicator.completed {
            background-color: #047857; /* Green for completed steps */
        }
        .component-list-item:hover {
            background-color: #1f2937;
        }
        /* Style for the case visualization */
        #pc-case-svg {
            width: 100%;
            height: auto;
            max-height: 70vh;
        }
        .visual-component, .remove-icon {
            transition: opacity 0.5s ease-in-out, fill 0.3s ease-in-out, stroke 0.3s ease-in-out;
        }
        .remove-icon-group:hover .remove-circle {
            fill: #ef4444; /* Brighter red on hover */
            cursor: pointer;
        }
        /* Style for Quantity Controls */
        .quantity-control button {
            transition: background-color 0.15s;
            line-height: 1; /* Ensure button text/icon is centered */
        }
        .quantity-control button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .quantity-display {
            min-width: 2rem;
            text-align: center;
        }
    </style>
</head>
<body class="text-gray-100 p-4 md:p-8">

    <div class="max-w-7xl mx-auto rounded-xl shadow-2xl card border">
        
        <!-- Header -->
        <header class="p-6 border-b border-gray-700">
            <h1 class="text-4xl font-extrabold text-blue-400">₹ Indian PC Builder</h1>
            <p class="text-gray-400 mt-1">Build your dream rig step-by-step, check compatibility, and get real-time price totals. (Prices are simulated based on current market trends.)</p>
        </header>

        <div class="md:flex">
            
            <!-- Left Column: Wizard & Controls -->
            <div class="md:w-7/12 p-6 border-r border-gray-700">
                <div id="step-indicators" class="flex justify-between mb-8">
                    <!-- Step Indicators will be populated here by JS -->
                </div>

                <!-- Wizard Content Area -->
                <div id="wizard-content">
                    <h2 id="step-title" class="text-2xl font-semibold mb-4 text-blue-300"></h2>
                    <p id="step-description" class="text-gray-400 mb-6"></p>
                    
                    <!-- Component Selection List -->
                    <div id="component-list" class="space-y-3 max-h-96 overflow-y-auto pr-2">
                        <!-- Component cards will be populated here -->
                    </div>

                    <!-- Compatibility and Message Box -->
                    <div id="message-box" class="mt-6 p-4 rounded-lg text-sm hidden"></div>
                </div>

                <!-- Navigation Buttons -->
                <div class="mt-8 flex justify-between">
                    <button id="prev-btn" onclick="prevStep()" class="px-6 py-2 bg-gray-600 hover:bg-gray-700 rounded-lg font-medium transition duration-150" disabled>
                        &larr; Previous
                    </button>
                    <button id="next-btn" onclick="nextStep()" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg font-medium transition duration-150" disabled>
                        Next &rarr;
                    </button>
                </div>
            </div>

            <!-- Right Column: Visual PC & Summary -->
            <div class="md:w-5/12 p-6 bg-[#0f141b] flex flex-col items-center">
                <h2 class="text-2xl font-bold mb-4 text-emerald-400">Current Build & Visualization</h2>

                <!-- PC Case Visualization (SVG Placeholder) -->
                <div class="w-full max-w-xs md:max-w-sm mb-6">
                    <svg id="pc-case-svg" viewBox="0 0 500 600" fill="none" xmlns="http://www.w3.org/2000/svg" class="transition duration-500 ease-in-out">
                        <!-- PC Case (Base) -->
                        <rect x="50" y="50" width="400" height="500" rx="15" fill="#2d3748" stroke="#4a5568" stroke-width="5"/>
                        <rect x="55" y="55" width="390" height="490" rx="10" fill="#1a202c"/>

                        <!-- Glass Side Panel (Visual effect) -->
                        <!-- visual-case corresponds to the entire side panel -->
                        <rect id="visual-case" class="visual-component" x="65" y="65" width="370" height="470" rx="8" fill="url(#gradient-glass)" opacity="0.8"/>
                        
                        <!-- Component Groups -->
                        
                        <!-- Motherboard Group (Enhanced Visual Feedback) -->
                        <g id="visual-motherboard-group">
                            <!-- Motherboard (Background/Outline) -->
                            <!-- Note: The fill color is transparent here so it doesn't block the RAM slots -->
                            <rect id="visual-motherboard" class="visual-component" x="100" y="100" width="300" height="350" rx="10" fill="transparent" stroke="#4a5568" stroke-dasharray="5,5" stroke-width="2" opacity="0.3"/>
                            <!-- Remove Icon: Centered on top right of the Motherboard -->
                            <g id="remove-motherboard" class="remove-icon-group" opacity="0" onclick="unselectPart('motherboard')">
                                <circle class="remove-circle" cx="385" cy="115" r="15" fill="#dc2626" stroke="#fef2f2" stroke-width="1.5"/>
                                <line x1="380" y1="110" x2="390" y2="120" stroke="#fef2f2" stroke-width="2"/>
                                <line x1="390" y1="110" x2="380" y2="120" stroke="#fef2f2" stroke-width="2"/>
                            </g>
                        </g>

                        <!-- CPU Group -->
                        <g id="visual-cpu-group">
                            <rect id="visual-cpu" class="visual-component" x="200" y="150" width="100" height="100" rx="5" fill="#38a169" opacity="0.3"/>
                            <!-- Remove Icon: Centered on top right of the CPU (200+100 - 15 = 285, 150+15 = 165) -->
                            <g id="remove-cpu" class="remove-icon-group" opacity="0" onclick="unselectPart('cpu')">
                                <circle class="remove-circle" cx="285" cy="165" r="15" fill="#dc2626" stroke="#fef2f2" stroke-width="1.5"/>
                                <line x1="280" y1="160" x2="290" y2="170" stroke="#fef2f2" stroke-width="2"/>
                                <line x1="290" y1="160" x2="280" y2="170" stroke="#fef2f2" stroke-width="2"/>
                            </g>
                        </g>

                        <!-- GPU Group -->
                        <g id="visual-gpu-group">
                            <rect id="visual-gpu" class="visual-component" x="120" y="270" width="260" height="60" rx="8" fill="#e53e3e" opacity="0.3"/>
                            <!-- Remove Icon: Centered on top right of the GPU (120+260 - 15 = 365, 270+15 = 285) -->
                            <g id="remove-gpu" class="remove-icon-group" opacity="0" onclick="unselectPart('gpu')">
                                <circle class="remove-circle" cx="365" cy="285" r="15" fill="#dc2626" stroke="#fef2f2" stroke-width="1.5"/>
                                <line x1="360" y1="280" x2="370" y2="290" stroke="#fef2f2" stroke-width="2"/>
                                <line x1="370" y1="280" x2="360" y2="290" stroke="#fef2f2" stroke-width="2"/>
                            </g>
                        </g>
                        
                        <!-- Dynamic RAM Slot Container -->
                        <g id="ram-slots-container">
                            <!-- RAM sticks will be dynamically inserted here by JavaScript -->
                        </g>

                        <!-- Storage Group -->
                        <g id="visual-storage-group">
                            <rect id="visual-storage" class="visual-component" x="380" y="480" width="40" height="40" rx="4" fill="#f6e05e" opacity="0.3"/>
                            <!-- Remove Icon: Centered on top right of Storage (380+40 - 10 = 410, 480+10 = 490) -->
                            <g id="remove-storage" class="remove-icon-group" opacity="0" onclick="unselectPart('storage')">
                                <circle class="remove-circle" cx="410" cy="490" r="10" fill="#dc2626" stroke="#fef2f2" stroke-width="1.5"/>
                                <line x1="407" y1="487" x2="413" y2="493" stroke="#fef2f2" stroke-width="2"/>
                                <line x1="413" y1="487" x2="407" y2="493" stroke="#fef2f2" stroke-width="2"/>
                            </g>
                        </g>

                        <!-- PSU Group -->
                        <g id="visual-psu-group">
                            <rect id="visual-psu" class="visual-component" x="70" y="470" width="100" height="60" rx="5" fill="#805ad5" opacity="0.3"/>
                            <!-- Remove Icon: Centered on top right of PSU (70+100 - 15 = 155, 470+15 = 485) -->
                            <g id="remove-psu" class="remove-icon-group" opacity="0" onclick="unselectPart('psu')">
                                <circle class="remove-circle" cx="155" cy="485" r="15" fill="#dc2626" stroke="#fef2f2" stroke-width="1.5"/>
                                <line x1="150" y1="480" x2="160" y2="490" stroke="#fef2f2" stroke-width="2"/>
                                <line x1="160" y1="480" x2="150" y2="490" stroke="#fef2f2" stroke-width="2"/>
                            </g>
                        </g>
                        
                        <!-- Visual Defs -->
                        <defs>
                            <linearGradient id="gradient-glass" x1="0" y1="0" x2="0" y2="1">
                                <stop offset="0%" stop-color="#3b82f6" stop-opacity="0.1"/>
                                <stop offset="100%" stop-color="#1e3a8a" stop-opacity="0.2"/>
                            </linearGradient>
                        </defs>
                        
                        <!-- Text Labels (Static for context) -->
                        <text x="250" y="40" fill="#cbd5e0" font-size="20" font-weight="bold" text-anchor="middle">THE BUILD</text>
                    </svg>
                </div>

                <!-- Build Summary -->
                <div id="build-summary" class="w-full space-y-2 text-sm">
                    <div class="font-bold text-lg text-blue-400 border-b border-gray-700 pb-2 mb-2">Selected Components</div>
                    <div id="summary-cpu" class="flex justify-between items-center text-gray-400"><span class="font-semibold text-gray-200 w-1/3">CPU:</span> <span class="text-right w-2/3 italic">Not Selected</span></div>
                    <div id="summary-motherboard" class="flex justify-between items-center text-gray-400"><span class="font-semibold text-gray-200 w-1/3">Motherboard:</span> <span class="text-right w-2/3 italic">Not Selected</span></div>
                    <div id="summary-ram" class="text-gray-400"><span class="font-semibold text-gray-200 block mb-1">RAM:</span> <span class="text-right w-full italic">Not Selected</span></div>
                    <div id="summary-gpu" class="flex justify-between items-center text-gray-400"><span class="font-semibold text-gray-200 w-1/3">GPU:</span> <span class="text-right w-2/3 italic">Not Selected</span></div>
                    <div id="summary-storage" class="flex justify-between items-center text-gray-400"><span class="font-semibold text-gray-200 w-1/3">Storage:</span> <span class="text-right w-2/3 italic">Not Selected</span></div>
                    <div id="summary-psu" class="flex justify-between items-center text-gray-400"><span class="font-semibold text-gray-200 w-1/3">PSU:</span> <span class="text-right w-2/3 italic">Not Selected</span></div>
                    <div id="summary-case" class="flex justify-between items-center text-gray-400"><span class="font-semibold text-gray-200 w-1/3">Case:</span> <span class="text-right w-2/3 italic">Not Selected</span></div>
                </div>

                <!-- Total Price -->
                <div class="mt-8 p-4 bg-gray-800 rounded-lg w-full">
                    <div class="flex justify-between items-center">
                        <span class="text-xl font-bold text-gray-200">Total Price:</span>
                        <span id="total-price" class="text-3xl font-extrabold text-green-400">₹ 0</span>
                    </div>
                    <p id="total-wattage" class="text-xs text-gray-500 mt-1 text-right">TDP: 0W / PSU Capacity: 0W</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- CONSTANTS AND DATA (Simulated Amazon/Indian Market Data) ---
        const STEP_ORDER = ['cpu', 'motherboard', 'ram', 'gpu', 'storage', 'psu', 'case'];
        const STEP_DETAILS = {
            cpu: { title: "1. Select CPU (Processor)", description: "The brain of your PC. It must be compatible with your Motherboard's socket." },
            motherboard: { title: "2. Select Motherboard", description: "The foundation of your PC. It must match the CPU socket and RAM type." },
            ram: { title: "3. Select RAM (Memory)", description: "Memory for running applications. Use the +/- buttons to select multiple sticks (e.g., 2x8GB or 4x16GB)." },
            gpu: { title: "4. Select GPU (Graphics Card)", description: "For gaming and heavy tasks. Ensure your PSU has enough wattage." },
            storage: { title: "5. Select Storage (SSD/HDD)", description: "Where your OS and files live. Faster SSDs are highly recommended." },
            psu: { title: "6. Select PSU (Power Supply)", description: "Provides power to all components. Ensure it covers the total wattage (TDP)." },
            case: { title: "7. Select Case", description: "The housing for your components. Aesthetics and size matter." }
        };

        // Simulated Products (Based on Indian market pricing)
        const PRODUCTS = {
            cpu: [
                { id: 1, name: "AMD Ryzen 5 5600G", price: 12500, socket: "AM4", ddr: "DDR4", tdp: 65, link: "https://amzn.to/budget-r5" },
                { id: 2, name: "Intel Core i5-13400F", price: 16000, socket: "LGA1700", ddr: "DDR4/DDR5", tdp: 65, link: "https://amzn.to/mid-i5" },
                { id: 3, name: "AMD Ryzen 7 7800X3D", price: 35000, socket: "AM5", ddr: "DDR5", tdp: 120, link: "https://amzn.to/high-r7" },
                { id: 4, name: "Intel Core i9-14900K", price: 58000, socket: "LGA1700", ddr: "DDR5", tdp: 125, link: "https://amzn.to/high-i9" }
            ],
            motherboard: [
                { id: 10, name: "Gigabyte B550M DS3H", price: 8500, socket: "AM4", ddr: "DDR4", max_ram_slots: 4 },
                { id: 11, name: "MSI PRO B760M-P DDR5", price: 13500, socket: "LGA1700", ddr: "DDR5", max_ram_slots: 4 },
                { id: 12, name: "ASUS ROG STRIX X670E-E", price: 42000, socket: "AM5", ddr: "DDR5", max_ram_slots: 4 }
            ],
            ram: [
                { id: 20, name: "G.Skill Ripjaws V 8GB DDR4 3200MHz", price: 2000, ddr: "DDR4", size_gb: 8 },
                { id: 21, name: "Corsair Vengeance RGB 16GB DDR5 6000MHz", price: 6000, ddr: "DDR5", size_gb: 16 }
            ],
            gpu: [
                { id: 30, name: "ZOTAC Gaming GTX 1650 OC", price: 13000, tdp: 75, wattage_rec: 350 },
                { id: 31, name: "NVIDIA GeForce RTX 4060 8GB", price: 32000, tdp: 115, wattage_rec: 550 },
                { id: 32, name: "ASUS TUF Gaming RTX 4080 SUPER 16GB", price: 115000, tdp: 320, wattage_rec: 850 }
            ],
            storage: [
                { id: 40, name: "Crucial P3 1TB NVMe Gen3 SSD", price: 5500 },
                { id: 41, name: "Samsung 990 Pro 2TB NVMe Gen4 SSD", price: 18000 }
            ],
            psu: [
                { id: 50, name: "DeepCool PK550D 550W 80+ Bronze", price: 3500, wattage: 550 },
                { id: 51, name: "Cooler Master MWE 750 V2 750W 80+ Gold", price: 7500, wattage: 750 },
                { id: 52, name: "Corsair HX1200i 1200W 80+ Platinum", price: 21000, wattage: 1200 }
            ],
            case: [
                { id: 60, name: "Ant Esports ICE-300 Mesh (Mid-Tower)", price: 4000 },
                { id: 61, name: "Lian Li Lancool 216 (Full-Tower)", price: 8000 }
            ]
        };
        
        // Maps component categories to the element ID in the SVG visualization
        const SVG_MAP = {
            cpu: 'visual-cpu',
            motherboard: 'visual-motherboard', 
            gpu: 'visual-gpu',
            storage: 'visual-storage',
            psu: 'visual-psu',
            case: 'visual-case' 
        };
        
        // Maps component categories to the REMOVE ICON GROUP ID in the SVG
        const REMOVE_ICON_MAP = {
            cpu: 'remove-cpu',
            motherboard: 'remove-motherboard',
            gpu: 'remove-gpu',
            storage: 'remove-storage',
            psu: 'remove-psu',
            case: 'remove-case' 
        };


        // --- STATE MANAGEMENT ---
        let currentStepIndex = 0;
        let buildState = {}; 

        // --- CORE FUNCTIONS ---
        
        // Helper function to get the total number of RAM sticks selected
        function getTotalRamSticks() {
            // FIX: Ensure buildState.ram is an array before calling reduce
            return (buildState.ram || []).reduce((total, item) => total + item.quantity, 0);
        }

        // Helper function to find a RAM product in the build state by its ID
        function getRamInBuild(partId) {
            return (buildState.ram || []).find(item => item.id === partId);
        }

        // Handles increment/decrement for multi-select components (currently only RAM)
        function adjustRamQuantity(partId, delta) {
            const part = PRODUCTS.ram.find(p => p.id === partId);
            const ramInBuild = getRamInBuild(partId);
            
            // Default max slots to 4 if motherboard hasn't been selected yet
            const maxSlots = buildState.motherboard ? buildState.motherboard.max_ram_slots : 4; 
            const currentTotalSticks = getTotalRamSticks();

            // Check compatibility only if motherboard is selected and we are trying to add a stick
            if (buildState.motherboard && delta > 0 && !checkCompatibility(part, 'ram').compatible) {
                showMessage(`Cannot add stick: DDR type mismatch with Motherboard (${buildState.motherboard.ddr}).`, 'error');
                return;
            }

            if (delta > 0) {
                // Increment logic
                if (currentTotalSticks >= maxSlots) {
                    showMessage(`Maximum ${maxSlots} RAM slots are already filled.`, 'error');
                    return;
                }

                if (ramInBuild) {
                    ramInBuild.quantity += 1;
                    showMessage(`Added one ${part.name} stick. Total sticks: ${currentTotalSticks + 1}`, 'info');
                } else {
                    // Initialize buildState.ram if it was null (though init should prevent this)
                    if (!buildState.ram) buildState.ram = [];
                    
                    // Add new type of RAM
                    buildState.ram.push({ ...part, quantity: 1 });
                    showMessage(`Added first ${part.name} stick. Total sticks: ${currentTotalSticks + 1}`, 'info');
                }
            } else if (delta < 0) {
                // Decrement logic
                if (ramInBuild) {
                    ramInBuild.quantity -= 1;
                    if (ramInBuild.quantity <= 0) {
                        // Remove the product entirely if quantity hits zero
                        buildState.ram = buildState.ram.filter(item => item.id !== partId);
                        showMessage(`Removed last ${part.name} stick.`, 'warning');
                    } else {
                        showMessage(`Removed one ${part.name} stick. Quantity remaining: ${ramInBuild.quantity}`, 'warning');
                    }
                }
            }
            
            // Re-render and update all UI elements
            renderStep();
            updateSummary();
        }


        function init() {
             STEP_ORDER.forEach(key => {
                if (key === 'ram') {
                    buildState[key] = []; // Initialize RAM as array for multi-selection
                } else {
                    buildState[key] = null;
                }
            });
            renderStepIndicators();
            renderStep();
            updateSummary();
        }

        function renderStepIndicators() {
            const container = document.getElementById('step-indicators');
            if (!container) return;

            container.innerHTML = STEP_ORDER.map((key, index) => {
                const statusClass = index < currentStepIndex ? 'completed' : (index === currentStepIndex ? 'active' : 'pending');
                return `
                    <div class="flex flex-col items-center w-1/${STEP_ORDER.length}">
                        <div class="step-indicator w-8 h-8 flex items-center justify-center rounded-full text-xs font-bold transition duration-300
                            ${statusClass === 'completed' ? 'completed' : ''}
                            ${statusClass === 'active' ? 'active' : 'bg-gray-700'}">
                            ${index + 1}
                        </div>
                        <span class="text-xs mt-1 text-center ${statusClass === 'active' ? 'text-blue-400' : (statusClass === 'completed' ? 'text-green-500' : 'text-gray-500')} hidden sm:block">${STEP_DETAILS[key].title.split(' ')[1].replace(/[()]|\d\./g, '')}</span>
                    </div>
                `;
            }).join('');
        }

        function renderStep() {
            const currentStepKey = STEP_ORDER[currentStepIndex];
            const detail = STEP_DETAILS[currentStepKey];
            const componentListContainer = document.getElementById('component-list');
            const messageBox = document.getElementById('message-box');
            const stepTitle = document.getElementById('step-title');
            const stepDescription = document.getElementById('step-description');
            const nextBtn = document.getElementById('next-btn');
            const prevBtn = document.getElementById('prev-btn');

            if(stepTitle) stepTitle.textContent = detail.title;
            if(stepDescription) stepDescription.textContent = detail.description;
            
            // Reset content and messages
            if(componentListContainer) componentListContainer.innerHTML = '';
            if(messageBox) {
                messageBox.className = 'mt-6 p-4 rounded-lg text-sm hidden';
                messageBox.textContent = '';
            }

            // Next button logic: Check if any part is selected (or at least one stick of RAM)
            const isSelected = currentStepKey === 'ram' ? getTotalRamSticks() > 0 : !!buildState[currentStepKey];
            if(nextBtn) document.getElementById('next-btn').disabled = !isSelected;

            PRODUCTS[currentStepKey].forEach(part => {
                const compatibilityResult = checkCompatibility(part, currentStepKey);
                
                let isSelected;
                let currentQuantity = 0;
                
                if (currentStepKey === 'ram') {
                    const ramInBuild = getRamInBuild(part.id);
                    isSelected = !!ramInBuild;
                    currentQuantity = ramInBuild ? ramInBuild.quantity : 0;
                } else {
                    isSelected = buildState[currentStepKey] && buildState[currentStepKey].id === part.id;
                }
                
                const cardClass = compatibilityResult.compatible 
                    ? (isSelected ? 'border-blue-500 ring-2 ring-blue-500' : 'border-gray-700 hover:border-blue-500 cursor-pointer') 
                    : 'border-red-700 opacity-50 cursor-not-allowed';
                
                let buttonHtml;

                if (currentStepKey === 'ram') {
                    // RAM Quantity Controls
                    const maxSlots = buildState.motherboard ? buildState.motherboard.max_ram_slots : 4;
                    const totalSticks = getTotalRamSticks();
                    const canIncrement = compatibilityResult.compatible && totalSticks < maxSlots;

                    buttonHtml = `
                        <div class="quantity-control flex items-center space-x-2">
                            <button onclick="adjustRamQuantity(${part.id}, -1)" class="w-8 h-8 bg-gray-600 hover:bg-gray-500 rounded-full font-bold" ${currentQuantity === 0 ? 'disabled' : ''}>
                                -
                            </button>
                            <span class="quantity-display text-lg font-bold text-gray-100">${currentQuantity}</span>
                            <button onclick="adjustRamQuantity(${part.id}, 1)" class="w-8 h-8 bg-blue-600 hover:bg-blue-500 rounded-full font-bold" ${!canIncrement ? 'disabled' : ''}>
                                +
                            </button>
                        </div>
                    `;
                } else {
                    // Single-select component
                    buttonHtml = compatibilityResult.compatible
                        ? `<button onclick="selectPart('${currentStepKey}', ${part.id})" class="text-sm px-4 py-2 rounded-full ${isSelected ? 'bg-blue-700' : 'bg-blue-600 hover:bg-blue-500'} transition duration-150" ${isSelected ? 'disabled' : ''}>
                              ${isSelected ? 'Selected' : 'Select Part'}
                           </button>`
                        : `<span class="text-xs text-red-400 font-semibold">Incompatible: ${compatibilityResult.reason}</span>`;
                }

                const componentCard = document.createElement('div');
                componentCard.className = `component-list-item p-4 border rounded-lg transition duration-200 ${cardClass}`;
                componentCard.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="font-semibold text-lg text-gray-100">${part.name} ${currentStepKey === 'ram' ? `(${part.size_gb}GB)` : ''}</p>
                            <p class="text-sm text-green-400 font-bold mt-1">₹ ${part.price.toLocaleString('en-IN')}</p>
                            <p class="text-xs text-gray-500 mt-1">${currentStepKey === 'psu' ? `Capacity: ${part.wattage}W` : (part.socket ? `Socket: ${part.socket}` : (part.ddr ? `DDR Type: ${part.ddr}` : ''))}</p>
                        </div>
                        <div class="text-right">
                            ${buttonHtml}
                            <a href="${part.link || '#'}" target="_blank" class="block mt-2 text-xs text-blue-400 hover:text-blue-300">View on Amazon (Simulated)</a>
                        </div>
                    </div>
                `;
                if(componentListContainer) componentListContainer.appendChild(componentCard);
            });

            // Update navigation buttons
            if(prevBtn) prevBtn.disabled = currentStepIndex === 0;
            if(nextBtn) nextBtn.textContent = currentStepIndex === STEP_ORDER.length - 1 ? "Finish Build" : "Next \u2192";
        }
        
        function selectPart(category, partId) {
            const part = PRODUCTS[category].find(p => p.id === partId);
            const compatibility = checkCompatibility(part, category);

            if (!compatibility.compatible) {
                showMessage(compatibility.reason, 'error');
                return;
            }

            // Single-select component logic
            buildState[category] = part;
            
            // If selecting a CPU/Mobo, reset dependent components to force re-selection
            if (category === 'cpu' || category === 'motherboard') {
                const dependentCategories = ['ram', 'gpu', 'psu'];
                dependentCategories.forEach(dep => {
                    if (dep === 'ram' && getTotalRamSticks() > 0) {
                        // Check compatibility of selected RAM types
                        const incompatibleRams = buildState.ram.filter(r => !checkCompatibility(r, 'ram').compatible);
                        if (incompatibleRams.length > 0) {
                            buildState.ram = []; // Invalidate incompatible array
                            showMessage(`Selection of ${part.name} invalidated previous RAM. Please re-select RAM.`, 'warning');
                        }
                    } else if (buildState[dep] && !checkCompatibility(buildState[dep], dep).compatible) {
                        buildState[dep] = null; // Invalidate incompatible part
                        showMessage(`Selection of ${part.name} invalidated your previous ${dep.toUpperCase()} choice. Please re-select.`, 'warning');
                    }
                });
            }
            
            renderStep(); // Re-render to show selection and update compatibility checks
            updateSummary();
        }
        
        function checkCompatibility(newPart, category) {
            const currentBuild = buildState;
            
            if (category === 'motherboard' && currentBuild.cpu) {
                if (newPart.socket !== currentBuild.cpu.socket) {
                    return { compatible: false, reason: `Socket mismatch. CPU requires ${currentBuild.cpu.socket}, Motherboard is ${newPart.socket}.` };
                }
            }
            
            if (category === 'cpu' && currentBuild.motherboard) {
                if (newPart.socket !== currentBuild.motherboard.socket) {
                    return { compatible: false, reason: `Socket mismatch. Motherboard is ${currentBuild.motherboard.socket}, CPU is ${newPart.socket}.` };
                }
            }

            if (category === 'ram' && currentBuild.motherboard) {
                // Check if the new part (stick) is compatible with the selected motherboard DDR
                if (newPart.ddr !== currentBuild.motherboard.ddr) {
                    return { compatible: false, reason: `DDR mismatch. Motherboard supports ${currentBuild.motherboard.ddr}, RAM is ${newPart.ddr}.` };
                }
            }
            
            // Check PSU Wattage vs. Total TDP + GPU/CPU requirements
            if (category === 'psu' && (currentBuild.cpu || currentBuild.gpu)) {
                const totalTDP = calculateTotalTDP(currentBuild.cpu, currentBuild.gpu);
                if (newPart.wattage < totalTDP * 1.2) { // 20% safety margin
                    return { compatible: false, reason: `Wattage too low. Total required TDP is ~${totalTDP}W, recommended PSU is >${Math.ceil(totalTDP * 1.2)}W.` };
                }
            }
            
            if (category === 'gpu' && currentBuild.psu) {
                 if (newPart.wattage_rec && newPart.wattage_rec > currentBuild.psu.wattage) {
                    return { compatible: false, reason: `PSU too weak. GPU recommends ${newPart.wattage_rec}W, but your PSU only has ${currentBuild.psu.wattage}W.` };
                 }
            }
            

            return { compatible: true, reason: '' };
        }

        function calculateTotalTDP(cpu, gpu) {
            const cpuTDP = cpu ? cpu.tdp : 0;
            const gpuTDP = gpu ? gpu.tdp : 0;
            // Simplified TDP calculation (CPU + GPU + 50W for everything else)
            return cpuTDP + gpuTDP + 50; 
        }
        
        // Function to draw all selected RAM sticks based on their total quantity
        function updateRamVisualization() {
            const container = document.getElementById('ram-slots-container');
            if (!container) return;
            container.innerHTML = ''; // Clear previous sticks

            const totalSticks = getTotalRamSticks();
            
            // If the user has selected more sticks than slots, we still only draw the max slots available
            const maxSlots = buildState.motherboard ? buildState.motherboard.max_ram_slots : 4;
            const sticksToDraw = Math.min(totalSticks, maxSlots);


            // RAM Stick Dimensions and Positioning (relative to SVG 500x600 viewBox)
            const STICK_WIDTH = 40;
            const STICK_HEIGHT = 80;
            const START_X = 310;
            const START_Y = 180;
            const GAP = 5;
            

            for (let i = 0; i < sticksToDraw; i++) {
                
                const x = START_X + (STICK_WIDTH + GAP) * i;
                const y = START_Y;

                // 1. Draw the RAM Stick (rectangle)
                const ramRect = document.createElementNS("http://www.w3.org/2000/svg", 'rect');
                ramRect.setAttribute('x', x);
                ramRect.setAttribute('y', y);
                ramRect.setAttribute('width', STICK_WIDTH);
                ramRect.setAttribute('height', STICK_HEIGHT);
                ramRect.setAttribute('rx', 4);
                ramRect.setAttribute('fill', '#63b3ed'); // Blue
                ramRect.setAttribute('opacity', '1');
                ramRect.classList.add('visual-component');
                container.appendChild(ramRect);

                // We do not add individual remove icons here, as control is centralized in the list
            }
            
            // If there are more sticks selected than slots, display an error message
            if (totalSticks > sticksToDraw) {
                showMessage(`Warning: You have selected ${totalSticks} RAM sticks, but your Motherboard only has ${maxSlots} slots.`, 'warning');
            }
        }
        
        function updateSummary() {
            let totalPrice = 0;
            let totalTDP = 50; // Base system draw

            // Update visualization for RAM separately
            updateRamVisualization();

            // Update summary and calculate price
            STEP_ORDER.forEach(key => {
                const summaryEl = document.getElementById(`summary-${key}`);
                
                if (key === 'ram') {
                    // RAM Multi-select summary
                    let totalRamGB = 0;
                    const totalSticks = getTotalRamSticks();
                    let ramHtml = `<span class="font-semibold text-gray-200 block mb-1">RAM (${totalSticks} Sticks):</span>`;
                    
                    if (totalSticks === 0) {
                         ramHtml += `<span class="text-right w-full italic">Not Selected</span>`;
                    } else {
                        (buildState.ram || []).forEach((part, index) => { // Defensive check added here too
                            const subtotalPrice = part.price * part.quantity;
                            totalPrice += subtotalPrice;
                            totalRamGB += (part.size_gb * part.quantity);
                            ramHtml += `
                                <div class="flex justify-between items-center text-gray-400 pl-4 py-1">
                                    <span class="text-sm truncate">${part.quantity}x ${part.size_gb}GB ${part.ddr} (${part.name.split(' ')[0]})</span>
                                    <span class="text-green-400 font-semibold text-xs ml-4 whitespace-nowrap">₹ ${subtotalPrice.toLocaleString('en-IN')}</span>
                                </div>
                            `;
                        });
                        ramHtml += `<div class="flex justify-between items-center pt-2 border-t border-gray-700/50 mt-1"><span class="font-bold text-gray-300">Total Capacity:</span><span class="font-bold text-lg text-blue-400">${totalRamGB} GB</span></div>`
                    }
                    if(summaryEl) summaryEl.innerHTML = ramHtml;
                    return; // Skip default logic for RAM
                }


                // Default Single-select component logic
                const part = buildState[key];
                const visualEl = document.getElementById(SVG_MAP[key]);
                const removeIconGroup = document.getElementById(REMOVE_ICON_MAP[key]);
                
                if (!summaryEl) return;

                if (part) {
                    totalPrice += part.price;
                    
                    // Update text summary
                    summaryEl.innerHTML = `
                        <span class="font-semibold text-gray-200 w-1/3">${key.charAt(0).toUpperCase() + key.slice(1)}:</span> 
                        <span class="text-right w-2/3 flex justify-end items-center">
                            <span class="text-gray-300 text-sm truncate">${part.name}</span>
                            <span class="text-green-400 font-semibold ml-4 whitespace-nowrap">₹ ${part.price.toLocaleString('en-IN')}</span>
                        </span>
                    `;
                    
                    // Update Visualization
                    if (visualEl) {
                        
                        // Handle Motherboard specifically with solid, glowing border
                        if (key === 'motherboard') {
                            visualEl.setAttribute('stroke', '#06b6d4'); // Cyan glow
                            visualEl.setAttribute('stroke-width', '4');
                            visualEl.removeAttribute('stroke-dasharray'); // Solid line
                            visualEl.style.opacity = '1';
                        } else if (key === 'case') {
                             // Case/Side Panel changes the glass gradient color slightly
                             visualEl.style.fill = 'url(#gradient-glass)';
                        } else {
                            // Default components (CPU, GPU, PSU, Storage)
                            visualEl.style.opacity = '1'; 
                            
                            // Set colors dynamically based on component type
                            let newColor = '#38a169'; // Default Green (CPU)
                            if (key === 'gpu') newColor = '#e53e3e'; // Red
                            if (key === 'psu') newColor = '#805ad5'; // Purple
                            if (key === 'storage') newColor = '#f6e05e'; // Yellow
                            
                            visualEl.setAttribute('fill', newColor);
                        }
                        
                        // Update TDP
                        if (key === 'cpu') totalTDP += part.tdp;
                        if (key === 'gpu') totalTDP += part.tdp;
                    }

                    // Show remove icon in visualization
                    if (removeIconGroup) {
                        removeIconGroup.style.opacity = '1';
                    }

                } else {
                    summaryEl.innerHTML = `<span class="font-semibold text-gray-200 w-1/3">${key.charAt(0).toUpperCase() + key.slice(1)}:</span> <span class="text-right w-2/3 italic">Not Selected</span>`;
                    
                    // Reset opacity in visualization and hide remove icon
                    if (visualEl) {
                        if (key === 'motherboard') {
                            visualEl.setAttribute('stroke', '#4a5568'); // Original grey
                            visualEl.setAttribute('stroke-width', '2');
                            visualEl.setAttribute('stroke-dasharray', '5,5'); // Dashed line
                            visualEl.style.opacity = '0.3';
                        } else {
                            visualEl.style.opacity = '0.3';
                        }
                    }
                    if (removeIconGroup) {
                        removeIconGroup.style.opacity = '0';
                    }
                }
            });

            // Update Total Price and Wattage
            const totalPriceEl = document.getElementById('total-price');
            const totalWattageEl = document.getElementById('total-wattage');

            if(totalPriceEl) totalPriceEl.textContent = `₹ ${totalPrice.toLocaleString('en-IN')}`;
            const psuCapacity = buildState.psu ? buildState.psu.wattage : 0;
            if(totalWattageEl) totalWattageEl.textContent = `TDP Estimate: ${totalTDP}W / PSU Capacity: ${psuCapacity}W`;
            
            // Check Final PSU compatibility after all parts (especially GPU/CPU) are selected
            if (buildState.psu && buildState.cpu && buildState.gpu) {
                const finalCheck = checkCompatibility(buildState.psu, 'psu');
                if (!finalCheck.compatible) {
                    showMessage(finalCheck.reason + " Please select a stronger PSU.", 'error');
                }
            }
        }
        
        function showMessage(text, type = 'info') {
            const messageBox = document.getElementById('message-box');
            if (!messageBox) return; // Prevent error if message box isn't found
            
            messageBox.textContent = text;
            messageBox.classList.remove('hidden', 'bg-red-900/40', 'bg-yellow-900/40', 'bg-blue-900/40', 'text-red-300', 'text-yellow-300', 'text-blue-300');

            if (type === 'error') {
                messageBox.classList.add('bg-red-900/40', 'text-red-300');
            } else if (type === 'warning') {
                messageBox.classList.add('bg-yellow-900/40', 'text-yellow-300');
            } else {
                messageBox.classList.add('bg-blue-900/40', 'text-blue-300');
            }
            messageBox.classList.remove('hidden');
        }

        // --- Function to remove a single-select component ---
        function unselectPart(category) {
            buildState[category] = null;
            showMessage(`${category.charAt(0).toUpperCase() + category.slice(1)} has been removed from the build.`, 'warning');

            // If a critical component (CPU/Mobo) is unselected, re-check dependencies
            if (category === 'cpu' || category === 'motherboard') {
                const dependentCategories = ['ram', 'gpu', 'psu'];
                dependentCategories.forEach(dep => {
                    if (dep === 'ram' && getTotalRamSticks() > 0) {
                        const incompatibleRams = buildState.ram.filter(r => !checkCompatibility(r, 'ram').compatible);
                        if (incompatibleRams.length > 0) {
                            buildState.ram = []; // Invalidate RAM sticks
                            showMessage(`Unselecting ${category.charAt(0).toUpperCase() + category.slice(1)} invalidated all previous RAM sticks. Please re-select RAM.`, 'warning');
                        }
                    } else if (buildState[dep] && !checkCompatibility(buildState[dep], dep).compatible) {
                        buildState[dep] = null; // Invalidate dependent part
                        showMessage(`Unselecting ${category.charAt(0).toUpperCase() + category.slice(1)} invalidated your previous ${dep.toUpperCase()} choice. Please re-select.`, 'warning');
                    }
                });
            }

            // If the user unselects a part in the current step, disable the Next button
            const nextBtn = document.getElementById('next-btn');
            const currentStepKey = STEP_ORDER[currentStepIndex];
            const isSelected = currentStepKey === 'ram' ? getTotalRamSticks() > 0 : !!buildState[currentStepKey];
            if (category === currentStepKey && nextBtn) {
                 nextBtn.disabled = !isSelected;
            }

            // Re-render and update UI
            renderStepIndicators();
            renderStep(); 
            updateSummary();
        }
        // ----------------------------------------


        function nextStep() {
            const currentStepKey = STEP_ORDER[currentStepIndex];
            const isSelected = currentStepKey === 'ram' ? getTotalRamSticks() > 0 : !!buildState[currentStepKey];

            if (!isSelected) {
                showMessage("Please select a compatible component before proceeding.", 'error');
                return;
            }
            
            if (currentStepIndex < STEP_ORDER.length - 1) {
                currentStepIndex++;
                renderStepIndicators();
                renderStep();
                const componentList = document.getElementById('component-list');
                if(componentList) componentList.scrollTo(0, 0); // Scroll to top of list
            } else {
                // Final Step Reached
                const totalPriceEl = document.getElementById('total-price');
                const nextBtn = document.getElementById('next-btn');

                if(totalPriceEl) showMessage(`Congratulations! Your custom PC build is complete. Total Estimated Cost: ${totalPriceEl.textContent}.`, 'info');
                if(nextBtn) nextBtn.disabled = true;
            }
        }

        function prevStep() {
            if (currentStepIndex > 0) {
                currentStepIndex--;
                renderStepIndicators();
                renderStep();
                const componentList = document.getElementById('component-list');
                if(componentList) componentList.scrollTo(0, 0); // Scroll to top of list
            }
        }

        // Initialize the application once the DOM is ready
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>